name: Release Management

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      pre_release:
        description: 'Create pre-release'
        required: false
        default: false
        type: boolean

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
        cache: true
        
    - name: Get current version
      id: current_version
      working-directory: .
      run: |
        CURRENT_VERSION=$(grep '^version:' pubspec.yaml | cut -d ' ' -f 2 | cut -d '+' -f 1)
        BUILD_NUMBER=$(grep '^version:' pubspec.yaml | cut -d '+' -f 2)
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
        
    - name: Calculate new version
      id: new_version
      run: |
        CURRENT="${{ steps.current_version.outputs.current_version }}"
        BUILD_NUMBER="${{ steps.current_version.outputs.build_number }}"
        
        IFS='.' read -ra VERSION_PARTS <<< "$CURRENT"
        MAJOR=${VERSION_PARTS[0]}
        MINOR=${VERSION_PARTS[1]}
        PATCH=${VERSION_PARTS[2]}
        
        case "${{ github.event.inputs.version_type }}" in
          "major")
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            ;;
          "minor")
            MINOR=$((MINOR + 1))
            PATCH=0
            ;;
          "patch")
            PATCH=$((PATCH + 1))
            ;;
        esac
        
        NEW_BUILD_NUMBER=$((BUILD_NUMBER + 1))
        NEW_VERSION="$MAJOR.$MINOR.$PATCH"
        NEW_FULL_VERSION="$NEW_VERSION+$NEW_BUILD_NUMBER"
        
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "new_full_version=$NEW_FULL_VERSION" >> $GITHUB_OUTPUT
        echo "new_build_number=$NEW_BUILD_NUMBER" >> $GITHUB_OUTPUT
        
    - name: Update pubspec.yaml version
      working-directory: .
      run: |
        sed -i "s/^version: .*/version: ${{ steps.new_version.outputs.new_full_version }}/" pubspec.yaml
        
    - name: Update version in app_config.dart
      working-directory: .
      run: |
        if [ -f "lib/core/app_config.dart" ]; then
          sed -i "s/static const String appVersion = .*/static const String appVersion = '${{ steps.new_version.outputs.new_version }}';/" lib/core/app_config.dart
        fi
        
    - name: Generate changelog
      id: changelog
      run: |
        # Generate changelog from git commits since last tag
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        if [ -z "$LAST_TAG" ]; then
          COMMITS=$(git log --pretty=format:"- %s" --no-merges)
        else
          COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s" --no-merges)
        fi
        
        CHANGELOG="## What's Changed\n\n$COMMITS"
        
        # Save changelog to file for later use
        echo -e "$CHANGELOG" > CHANGELOG_TEMP.md
        
    - name: Commit version bump
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add pubspec.yaml
        if [ -f "lib/core/app_config.dart" ]; then
          git add lib/core/app_config.dart
        fi
        git commit -m "chore: bump version to ${{ steps.new_version.outputs.new_version }}"
        git push
        
    - name: Create and push tag
      run: |
        git tag -a "v${{ steps.new_version.outputs.new_version }}" -m "Release version ${{ steps.new_version.outputs.new_version }}"
        git push origin "v${{ steps.new_version.outputs.new_version }}"
        
    - name: Trigger build workflow
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'build-android.yml',
            ref: 'v${{ steps.new_version.outputs.new_version }}'
          });

  update-documentation:
    needs: create-release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: main
        
    - name: Update README with latest release info
      run: |
        # Update README.md with latest version info
        sed -i 's/Version: [0-9]\+\.[0-9]\+\.[0-9]\+/Version: ${{ needs.create-release.outputs.new_version }}/g' README.md || true
        
    - name: Commit documentation updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        git diff --staged --quiet || git commit -m "docs: update documentation for version ${{ needs.create-release.outputs.new_version }}"
        git push || true