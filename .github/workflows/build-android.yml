name: Build and Release Android APK

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
        cache: true
        
    - name: Get Flutter dependencies
      working-directory: .
      run: flutter pub get
      
    - name: Run Flutter analyzer
      working-directory: .
      run: flutter analyze --no-fatal-infos || echo "‚ö†Ô∏è Analyzer found issues but continuing"
      
    - name: Run Flutter tests
      working-directory: .
      run: flutter test
      
    - name: Create google-services.json from secret
      working-directory: ./android/app
      run: |
        if [ -n "${{ secrets.GOOGLE_SERVICES_JSON }}" ]; then
          echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > google-services.json
        else
          echo "Creating placeholder google-services.json for build"
          cat > google-services.json << 'EOF'
        {
          "project_info": {
            "project_number": "000000000000",
            "project_id": "placeholder-project"
          },
          "client": [
            {
              "client_info": {
                "mobilesdk_app_id": "1:000000000000:android:0000000000000000000000",
                "android_client_info": {
                  "package_name": "com.doorphone.doorphone_viewer"
                }
              },
              "oauth_client": [],
              "api_key": [
                {
                  "current_key": "placeholder-api-key"
                }
              ],
              "services": {
                "appinvite_service": {
                  "other_platform_oauth_client": []
                }
              }
            }
          ],
          "configuration_version": "1"
        }
        EOF
        fi
      
    - name: Create AWS certificates directory
      working-directory: .
      run: mkdir -p assets/certificates
      
    - name: Create placeholder certificates (for build only)
      working-directory: ./assets/certificates
      run: |
        echo "# Placeholder certificate for build" > certificate.pem.crt
        echo "# Placeholder private key for build" > private.pem.key
        echo "# Placeholder root CA for build" > AmazonRootCA1.pem
        
    - name: Build APK (Debug)
      working-directory: .
      run: flutter build apk --debug
      
    - name: Build APK (Release)
      working-directory: .
      run: flutter build apk --release
      
    - name: Build App Bundle (Release)
      working-directory: .
      run: flutter build appbundle --release
      
    - name: Get version from pubspec.yaml
      id: version
      working-directory: .
      run: |
        VERSION=$(grep '^version:' pubspec.yaml | cut -d ' ' -f 2 | cut -d '+' -f 1)
        BUILD_NUMBER=$(grep '^version:' pubspec.yaml | cut -d '+' -f 2)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
        echo "full_version=$VERSION+$BUILD_NUMBER" >> $GITHUB_OUTPUT
        
    - name: Rename APK files
      working-directory: .
      run: |
        mv build/app/outputs/flutter-apk/app-debug.apk build/app/outputs/flutter-apk/doorphone-viewer-debug-${{ steps.version.outputs.full_version }}.apk
        mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/doorphone-viewer-release-${{ steps.version.outputs.full_version }}.apk
        mv build/app/outputs/bundle/release/app-release.aab build/app/outputs/bundle/release/doorphone-viewer-release-${{ steps.version.outputs.full_version }}.aab
        
    - name: Upload Debug APK as artifact
      uses: actions/upload-artifact@v4
      with:
        name: doorphone-viewer-debug-apk
        path: build/app/outputs/flutter-apk/doorphone-viewer-debug-${{ steps.version.outputs.full_version }}.apk
        
    - name: Upload Release APK as artifact
      uses: actions/upload-artifact@v4
      with:
        name: doorphone-viewer-release-apk
        path: build/app/outputs/flutter-apk/doorphone-viewer-release-${{ steps.version.outputs.full_version }}.apk
        
    - name: Upload App Bundle as artifact
      uses: actions/upload-artifact@v4
      with:
        name: doorphone-viewer-release-aab
        path: build/app/outputs/bundle/release/doorphone-viewer-release-${{ steps.version.outputs.full_version }}.aab

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Get version from tag
      id: tag_version
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        VERSION=${TAG#v}
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
    - name: Download Release APK
      uses: actions/download-artifact@v4
      with:
        name: doorphone-viewer-release-apk
        path: ./artifacts
        
    - name: Download App Bundle
      uses: actions/download-artifact@v4
      with:
        name: doorphone-viewer-release-aab
        path: ./artifacts
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag_version.outputs.tag }}
        name: Doorphone Viewer ${{ steps.tag_version.outputs.version }}
        body: |
          ## Doorphone Viewer ${{ steps.tag_version.outputs.version }}
          
          ### üì± Android Release
          
          **APK File**: Install directly on Android devices
          **AAB File**: For Google Play Store distribution
          
          ### üîß Features
          - Real-time video streaming via AWS KVS WebRTC
          - Remote door control via AWS IoT MQTT
          - Push notifications for doorbell events
          - Multi-device support
          - Material Design 3 UI
          
          ### üìã Requirements
          - Android 5.0 (API level 21) or higher
          - Camera and microphone permissions
          - Internet connection
          - AWS IoT and KVS configuration
          
          ### üîê Security Note
          This build uses placeholder certificates. For production use, configure your own AWS IoT certificates and Firebase configuration.
          
          ---
          
          **Installation**: Download the APK file and install on your Android device. You may need to enable "Install from unknown sources" in your device settings.
          
        files: |
          ./artifacts/*.apk
          ./artifacts/*.aab
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    needs: [build, release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Build Status Notification
      run: |
        if [ "${{ needs.build.result }}" == "success" ]; then
          echo "‚úÖ Build completed successfully"
        else
          echo "‚ùå Build failed"
          exit 1
        fi
        
        if [ "${{ needs.release.result }}" == "success" ] && [ "${{ needs.release.result }}" != "skipped" ]; then
          echo "üöÄ Release published successfully"
        elif [ "${{ needs.release.result }}" == "skipped" ]; then
          echo "‚è≠Ô∏è Release skipped (not a tag push)"
        else
          echo "‚ùå Release failed"
        fi