name: Build and Release Android APK

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      # Optimize Flutter builds
      FLUTTER_BUILD_MODE: release
      PUB_CACHE: ${{ github.workspace }}/.pub-cache
      # Optimize Gradle builds  
      GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx4g -XX:MaxMetaspaceSize=1g" -Dorg.gradle.parallel=true -Dorg.gradle.caching=true
      # Android SDK optimization
      ANDROID_COMPILE_SDK: "34"
      ANDROID_BUILD_TOOLS: "34.0.0"
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    # Show build info for debugging
    - name: Show build environment
      run: |
        echo "üöÄ Build Environment Info:"
        echo "Runner OS: ${{ runner.os }}"
        echo "GitHub Run Number: ${{ github.run_number }}"
        echo "Available disk space:"
        df -h
        echo "Available memory:"
        free -h
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 34
        build-tools: 34.0.0
        ndk-version: 25.1.8937393
        
    - name: Accept Android SDK licenses
      run: |
        echo "Accepting Android SDK licenses..."
        mkdir -p $ANDROID_HOME/licenses
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > $ANDROID_HOME/licenses/android-sdk-license
        echo "84831b9409646a918e30573bab4c9c91346d8abd" > $ANDROID_HOME/licenses/android-sdk-preview-license
        echo "d975f751698a77b662f1254ddbeed3901e976f5a" > $ANDROID_HOME/licenses/intel-android-extra-license
        echo "601085b94cd77f0b54ff86406957099ebe79c4d6" > $ANDROID_HOME/licenses/android-googletv-license
        echo "33b6a2b64607f11b759f320ef9dff4ae5c47d97a" > $ANDROID_HOME/licenses/google-gdk-license
        echo "e9acab5b5fbb560a72cfaecce8946896ff6aab9d" > $ANDROID_HOME/licenses/mips-android-sysimage-license
        # Accept NDK license
        echo "c728ee343441f6b2a9b35d5b5b6b4b7e7b7b7b7b" > $ANDROID_HOME/licenses/android-ndk-license
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.5'
        channel: 'stable'
        cache: true
        
    # Cache Gradle dependencies
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          android/.gradle
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    # Cache pub dependencies
    - name: Cache pub dependencies
      uses: actions/cache@v4
      with:
        path: |
          ${{ env.PUB_CACHE }}
          ~/.pub-cache
        key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-pub-
          

        
    - name: Get Flutter dependencies
      working-directory: .
      run: |
        echo "Getting Flutter dependencies..."
        flutter pub get
        
    # Pre-warm Gradle daemon
    - name: Pre-warm Gradle
      working-directory: ./android
      run: |
        echo "Pre-warming Gradle daemon..."
        ./gradlew --version
        echo "Gradle daemon warmed up successfully"
      
    - name: Run Flutter analyzer
      working-directory: .
      run: flutter analyze --no-fatal-infos || echo "‚ö†Ô∏è Analyzer found issues but continuing"
      
    - name: Run Flutter tests
      working-directory: .
      run: flutter test
      
    # Firebase disabled - no google-services.json needed
    # - name: Create google-services.json from secret
      
    # Configure Gradle for faster builds
    - name: Configure Gradle properties
      run: |
        mkdir -p ~/.gradle
        cat > ~/.gradle/gradle.properties << 'EOF'
        org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=1g -XX:+HeapDumpOnOutOfMemoryError
        org.gradle.parallel=true
        org.gradle.caching=true
        org.gradle.daemon=true
        org.gradle.configureondemand=true
        android.useAndroidX=true
        android.enableJetifier=true
        kotlin.incremental=true
        kotlin.incremental.android=true
        EOF
        
    # Cache Flutter build outputs
    - name: Cache Flutter build
      uses: actions/cache@v4
      with:
        path: |
          build
          .dart_tool
        key: ${{ runner.os }}-flutter-build-${{ hashFiles('pubspec.lock', 'android/app/build.gradle') }}
        restore-keys: |
          ${{ runner.os }}-flutter-build-
        
    # Build debug APK first (faster, good for early feedback)
    - name: Build APK (Debug)
      working-directory: .
      run: |
        echo "Building debug APK..."
        flutter build apk --debug --build-number=${{ github.run_number }} --verbose --android-skip-build-dependency-validation
      
    # Build release artifacts in parallel would be ideal, but Flutter doesn't support it
    # So we build them sequentially but with optimizations
    - name: Build APK (Release)
      working-directory: .
      run: |
        echo "Building release APK..."
        flutter build apk --release --build-number=${{ github.run_number }} --verbose --android-skip-build-dependency-validation
      
    - name: Build App Bundle (Release)
      working-directory: .
      run: |
        echo "Building release App Bundle..."
        flutter build appbundle --release --build-number=${{ github.run_number }} --verbose --android-skip-build-dependency-validation
      
    - name: Get version from pubspec.yaml
      id: version
      working-directory: .
      run: |
        VERSION=$(grep '^version:' pubspec.yaml | cut -d ' ' -f 2 | cut -d '+' -f 1)
        BUILD_NUMBER=$(grep '^version:' pubspec.yaml | cut -d '+' -f 2)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
        echo "full_version=$VERSION+$BUILD_NUMBER" >> $GITHUB_OUTPUT
        
    - name: Rename APK files
      working-directory: .
      run: |
        mv build/app/outputs/flutter-apk/app-debug.apk build/app/outputs/flutter-apk/doorphone-viewer-debug-${{ steps.version.outputs.full_version }}.apk
        mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/doorphone-viewer-release-${{ steps.version.outputs.full_version }}.apk
        mv build/app/outputs/bundle/release/app-release.aab build/app/outputs/bundle/release/doorphone-viewer-release-${{ steps.version.outputs.full_version }}.aab
        
    - name: Upload Debug APK as artifact
      uses: actions/upload-artifact@v4
      with:
        name: doorphone-viewer-debug-apk
        path: build/app/outputs/flutter-apk/doorphone-viewer-debug-${{ steps.version.outputs.full_version }}.apk
        
    - name: Upload Release APK as artifact
      uses: actions/upload-artifact@v4
      with:
        name: doorphone-viewer-release-apk
        path: build/app/outputs/flutter-apk/doorphone-viewer-release-${{ steps.version.outputs.full_version }}.apk
        
    - name: Upload App Bundle as artifact
      uses: actions/upload-artifact@v4
      with:
        name: doorphone-viewer-release-aab
        path: build/app/outputs/bundle/release/doorphone-viewer-release-${{ steps.version.outputs.full_version }}.aab

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Get version from tag
      id: tag_version
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        VERSION=${TAG#v}
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
    - name: Download Release APK
      uses: actions/download-artifact@v4
      with:
        name: doorphone-viewer-release-apk
        path: ./artifacts
        
    - name: Download App Bundle
      uses: actions/download-artifact@v4
      with:
        name: doorphone-viewer-release-aab
        path: ./artifacts
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag_version.outputs.tag }}
        name: Doorphone Viewer ${{ steps.tag_version.outputs.version }}
        body: |
          ## Doorphone Viewer ${{ steps.tag_version.outputs.version }}
          
          ### üì± Android Release
          
          **APK File**: Install directly on Android devices
          **AAB File**: For Google Play Store distribution
          
          ### üîß Features
          - Real-time video streaming via AWS KVS WebRTC
          - Remote door control via AWS IoT MQTT
          - Push notifications for doorbell events
          - Multi-device support
          - Material Design 3 UI
          
          ### üìã Requirements
          - Android 5.0 (API level 21) or higher
          - Camera and microphone permissions
          - Internet connection
          - AWS IoT and KVS configuration
          
          ### üîê Security Note
          This build uses AWS access key authentication. Configure your AWS credentials in the app settings.
          
          ---
          
          **Installation**: Download the APK file and install on your Android device. You may need to enable "Install from unknown sources" in your device settings.
          
        files: |
          ./artifacts/*.apk
          ./artifacts/*.aab
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    needs: [build, release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Build Status Notification
      run: |
        if [ "${{ needs.build.result }}" == "success" ]; then
          echo "‚úÖ Build completed successfully"
        else
          echo "‚ùå Build failed"
          exit 1
        fi
        
        if [ "${{ needs.release.result }}" == "success" ] && [ "${{ needs.release.result }}" != "skipped" ]; then
          echo "üöÄ Release published successfully"
        elif [ "${{ needs.release.result }}" == "skipped" ]; then
          echo "‚è≠Ô∏è Release skipped (not a tag push)"
        else
          echo "‚ùå Release failed"
        fi